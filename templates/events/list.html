{% extends "base.html" %}
{% block content %}
<h2>Campus Events</h2>

<div class="event-header">
  <div class="event-header-buttons">

    <a href="{{ url_for('event_bp.calendar_view') }}" class="btn calendar-btn icon-btn">
      <svg class="icon" viewBox="0 0 24 24">
        <path fill="currentColor" d="M19 4h-1V2h-2v2H8V2H6v2H5C3.89 4 3 4.9 3 6v14c0 
        1.1.89 2 2 2h14c1.1 0 2-.9 
        2-2V6c0-1.1-.9-2-2-2zm0 
        16H5V9h14v11zM7 11h5v5H7v-5z"/>
      </svg>
      Calendar View
    </a>

    {% if session.get('logged_in') %}
      <a href="{{ url_for('event_bp.add_event') }}" class="btn add-btn icon-btn">
        <svg class="icon" viewBox="0 0 24 24">
          <path fill="currentColor" d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
        </svg>
        Add New Event
      </a>
    {% else %}
      <a href="{{ url_for('event_bp.add_event') }}" 
         class="btn add-btn disabled-btn icon-btn"
         title="Login required">
        <svg class="icon" viewBox="0 0 24 24">
          <path fill="currentColor" d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
        </svg>
        Add New Event
      </a>
    {% endif %}

  </div>
</div>

<form method="get" class="search-filter" style="margin-bottom: 1rem;">
  <input
    type="text"
    name="q"
    placeholder="Search events..."
    value="{{ q or '' }}"
  >

  <select name="category">
    <option value="">All categories</option>
    {% for c in categories %}
      <option value="{{ c }}"
        {% if selected_category == c %}selected{% endif %}>
        {{ c }}
      </option>
    {% endfor %}
  </select>

  <button type="submit" class="btn">Search</button>
</form>


<div class="event-grid">

  {% for e in events %}
  <div class="event-card">
    
    {% if e.created_by == session.get('user_id') %}
      <div class="card-badge-you">Added by you</div>
    {% endif %}

    
    <h3>{{ e.title }}</h3>
    
    {% if e.status == 'active' %}
    <span class="verified"> âœ” Verified by community</span>
    {% elif e.status == 'flagged' %}
        <span class="flagged">âš  Needs review</span>
    {% else %}
        <span class="removed"> Removed</span>
    {% endif %}

    <div class="vote-box">
      <button class="vote-btn" onclick="vote('event','{{ e.event_id }}', 'up')">â¬†</button>
      <span>{{ e.upvotes }}</span>
  
      <button class="vote-btn" onclick="vote('event','{{ e.event_id }}', 'down')">â¬‡</button>
      <span>{{ e.downvotes }}</span>
  </div>
  

    {% if e.status != 'removed' %}

    <p><strong>Date & Time:</strong> {{ e.date_of_event }}</p>
    <p><strong>Description: </strong> {{ e.description }}</p>
    <p><strong>Contact Info: </strong> {{ e.contact_info if e.contact_info else "No contact info provided." }}</p>
   

    {% if e.address1 %}
    <p><strong>Location:</strong> {{ e.address1 }} {% if e.address2 %}, {{ e.address2 }}{% endif %}, {{ e.city }}, {{ e.state }} {{ e.postal_code }}</p>
    {% endif %}

    <div class="actions">
      <a href="{{ url_for('event_bp.event_details', event_id=e.event_id) }}" class="btn-sm view">View</a>
      <a href="{{ url_for('event_bp.edit_event', event_id=e.event_id) }}" class="btn-sm edit">Edit</a>
      <form action="{{ url_for('event_bp.delete_event', event_id=e.event_id) }}"
            method="POST" class="inline-form">
        <button type="submit" class="btn-sm delete">Delete</button>
      </form>
    </div>

    <div class="comment-section" data-event-id="{{ e.event_id }}">
      <button class="toggle-comments-btn" onclick="toggleComments('{{ e.event_id }}')">
          ðŸ’¬ View Comments
      </button>
    
      <div class="comments-area" id="comments-box-{{ e.event_id }}" style="display:none;">
          <div class="comments-list" id="comments-event-{{ e.event_id }}"></div>
    
          {% if session.get('logged_in') %}
            <textarea class="comment-input" 
                      id="input-event-{{ e.event_id }}" 
                      placeholder="Write a comment..."></textarea>
            <button class="comment-post-btn" 
                    onclick="postEventComment('{{ e.event_id }}')">Post</button>
          {% else %}
            <p class="comment-login-msg">Login to leave a comment.</p>
          {% endif %}
      </div>
    </div>

    {% endif %}

  </div>
  {% else %}
  <p>No events posted yet. Add one to get started!</p>
  {% endfor %}
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".comment-section").forEach(section => {
    const eventId = section.dataset.eventId;
    loadEventComments(eventId);
  });
});

function loadEventComments(eventId) {
  fetch(`/comments/event/${eventId}`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById(`comments-event-${eventId}`);
      container.innerHTML = data.map(c => `
  <div class="comment">
    <div class="comment-header">
      <strong>${c.author}</strong>
      ${c.owned ? `
        <span class="comment-actions">
          <button class="comment-edit" onclick="editComment(${c.comment_id}, '${c.content.replace(/'/g, "\\'")}')">Edit</button>
          <button class="comment-delete" onclick="deleteComment(${c.comment_id}, ${c.event_id}, ${c.resource_id})">Delete</button>
        </span>
      ` : ""}
    </div>

    <p class="comment-content">${c.content}</p>
    <span class="time">${new Date(c.created_at).toLocaleString()}</span>
  </div>
`).join("");
    });
}

function postEventComment(eventId) {
  const input = document.getElementById(`input-event-${eventId}`);
  const content = input.value.trim();
  if (!content) return;

  fetch("/comments", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      content: content,
      event_id: Number(eventId),
      resource_id: null
    })
  }).then(() => {
    input.value = "";
    loadEventComments(eventId);
  });
}

function toggleComments(eventId) {
  const box = document.getElementById(`comments-box-${eventId}`);
  const btn = box.previousElementSibling;

  if (box.style.display === "none") {
    box.style.display = "block";
    btn.textContent = "ðŸ’¬ Hide Comments";
    loadEventComments(eventId);
  } else {
    box.style.display = "none";
    btn.textContent = "ðŸ’¬ View Comments";
  }
}
function deleteComment(commentId, eventId, resourceId) {
  if (!confirm("Delete this comment?")) return;

  fetch(`/comments/${commentId}`, { method: "DELETE" })
    .then(res => res.json())
    .then(() => {
      if (eventId) loadEventComments(eventId);
      if (resourceId) loadResourceComments(resourceId);
    });
}

function editComment(commentId, oldContent) {
  const newContent = prompt("Edit your comment:", oldContent);
  if (newContent === null) return;

  fetch(`/comments/${commentId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ content: newContent })
  })
  .then(res => res.json())
  .then(() => {
    // reload both pages correctly
    const eventBox = document.querySelector(`[id^="comments-event-"]`);
    const resourceBox = document.querySelector(`[id^="comments-resource-"]`);

    if (eventBox) {
      const eventId = eventBox.id.replace("comments-event-", "");
      loadEventComments(eventId);
    }
    if (resourceBox) {
      const resourceId = resourceBox.id.replace("comments-resource-", "");
      loadResourceComments(resourceId);
    }
  });
}

async function vote(type, id, voteType) {
    let res = await fetch(`/votes/${type}/${id}`, {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ vote: voteType })
    });

    const data = await res.json();
    console.log(data);

    location.reload(); // refresh to show updated votes
}
</script>

{% endblock %}
