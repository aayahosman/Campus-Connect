{% extends "base.html" %}
{% block content %}
<h2>Campus Events</h2>

<div class="event-header">
  <div class="event-header-buttons">

    <a href="{{ url_for('event_bp.calendar_view') }}" class="btn calendar-btn icon-btn">
      <svg class="icon" viewBox="0 0 24 24">
        <path fill="currentColor" d="M19 4h-1V2h-2v2H8V2H6v2H5C3.89 4 3 4.9 3 6v14c0
        1.1.89 2 2 2h14c1.1 0 2-.9
        2-2V6c0-1.1-.9-2-2-2zm0
        16H5V9h14v11zM7 11h5v5H7v-5z"/>
      </svg>
      Calendar View
    </a>

    {% if session.get('logged_in') %}
      <a href="{{ url_for('event_bp.add_event') }}" class="btn add-btn icon-btn">
        <svg class="icon" viewBox="0 0 24 24">
          <path fill="currentColor" d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
        </svg>
        Add New Event
      </a>
    {% else %}
      <a href="{{ url_for('event_bp.add_event') }}"
         class="btn add-btn disabled-btn icon-btn"
         title="Login required">
        <svg class="icon" viewBox="0 0 24 24">
          <path fill="currentColor" d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
        </svg>
        Add New Event
      </a>
    {% endif %}

  </div>
</div>

<form method="get" class="search-filter" style="margin-bottom: 1rem;">
  <label for="event-search" class="sr-only">Search events</label>
  <input
    id="event-search"
    type="text"
    name="q"
    placeholder="Search events..."
    value="{{ q or '' }}"
  >


  <label for="event-category" class="sr-only">Filter events by category</label>
  <select id="event-category" name="category">
    <option value="">All categories</option>
    {% for c in categories %}
      <option value="{{ c }}"
        {% if selected_category == c %}selected{% endif %}>
        {{ c }}
      </option>
    {% endfor %}
  </select>

  <div class="search-filter-buttons">
    <button type="submit" class="search-btn">Search</button>

    <a href="{{ url_for('event_bp.list_events') }}" class="clear-filter-btn">
      Clear Filters
    </a>
  </div>
</form>



<div class="event-grid">

  {% for e in events %}
  <div class="event-card">

    {% if e.created_by == session.get('user_id') %}
      <div class="card-badge-you">Added by you</div>
    {% endif %}
    
    {% if e.image_filename %}
      <img src="{{ url_for('uploaded_file', filename=e.image_filename) }}"
       alt="Image for {{ e.title }}"
       class="event-thumb">
    {% endif %}

    <h3>{{ e.title }}</h3>

    <p><strong>Date & Time:</strong> {{ e.date_of_event }}</p>
    <p><strong>Category: </strong> {{ e.category }}</p>
    <p><strong>Description: </strong> {{ e.description }}</p>
    <p><strong>Contact Info: </strong> {{ e.contact_info if e.contact_info else "No contact info provided." }}</p>

    {% if e.address1 %}
    <p><strong>Location:</strong> {{ e.address1 }}{% if e.address2 %}, {{ e.address2 }}{% endif %}, {{ e.city }}, {{ e.state }} {{ e.postal_code }}</p>
    {% endif %}

    <div class="actions">
      <a href="{{ url_for('event_bp.event_details', event_id=e.event_id) }}" class="btn-sm view">View</a>
      <a href="{{ url_for('event_bp.edit_event', event_id=e.event_id) }}" class="btn-sm edit">Edit</a>
      <form action="{{ url_for('event_bp.delete_event', event_id=e.event_id) }}" method="POST" class="inline-form">
        <button type="submit" class="btn-sm delete">Delete</button>
      </form>
    </div>

    <!-- VERIFICATION + VOTES AT THE BOTTOM -->
    <div class="verification-box">

      {% if e.upvotes >= 25 %}
        <span class="verified">âœ” Verified by community</span>
      {% elif e.status == 'flagged' %}
        <span class="flagged">âš  Needs review</span>
      {% elif e.status == 'removed' %}
        <span class="removed"> âœ– Removed</span>
      {% else %}
        <span class="unverified">â§— Pending verification</span>
      {% endif %}

      <div class="vote-box">
        <button class="vote-btn" onclick="vote('event','{{ e.event_id }}','up')">â¬†</button>
        <span>{{ e.upvotes }}</span>

        <button class="vote-btn" onclick="vote('event','{{ e.event_id }}','down')">â¬‡</button>
        <span>{{ e.downvotes }}</span>
      </div>
    </div>

    <!-- COMMENTS SECTION -->
    <div class="comment-section" data-event-id="{{ e.event_id }}">
      <button class="toggle-comments-btn" onclick="toggleComments('{{ e.event_id }}')">
        ðŸ’¬ View Comments
      </button>

      <div class="comments-area" id="comments-box-{{ e.event_id }}" style="display:none;">
        <div class="comments-list" id="comments-event-{{ e.event_id }}"></div>

        {% if session.get('logged_in') %}
        <label for="input-event-{{ e.event_id }}" class="sr-only">
            Comment on this event
        </label>

        <textarea
          class="comment-input"
          id="input-event-{{ e.event_id }}"
          placeholder="Write a comment...">
        </textarea>


          <button class="comment-post-btn" onclick="postEventComment('{{ e.event_id }}')">Post</button>
        {% else %}
          <p class="comment-login-msg">Login to leave a comment.</p>
        {% endif %}
      </div>
    </div>

</div> <!-- END EVENT CARD -->
  {% else %}
    {% if q or selected_category %}
      <p>No events matched your search.</p>
    {% else %}
      <p>No events posted yet. Add one to get started!</p>
    {% endif %}
  {% endfor %}
</div>

<!-- Edit Comment Modal -->
<div id="edit-comment-modal" class="modal-overlay" style="display: none;">
  <div class="modal">
    <label for="edit-comment-text" class="sr-only">
      Edit your comment text
    </label>

<textarea id="edit-comment-text" rows="4"></textarea>


  <div class="modal-actions">
    <button id="edit-comment-save-btn" class="modal-btn modal-btn-primary">Save</button>
    <button id="edit-comment-cancel-btn" class="modal-btn modal-btn-secondary">Cancel</button>
  </div>

  </div>
</div>

<!-- Delete Comment Modal -->
<div id="delete-comment-modal" class="modal-overlay" style="display: none;">
  <div class="modal modal-danger">
    <h3>Delete comment?</h3>
    <p style="margin: 0.25rem 0 0.75rem 0; font-size: 0.9rem;">
      This action canâ€™t be undone.
    </p>

    <div class="modal-actions">
      <button id="delete-comment-confirm-btn" class="modal-btn modal-btn-primary" style="background-color:#d32f2f;">
        Delete
      </button>
      <button id="delete-comment-cancel-btn" class="modal-btn modal-btn-secondary">
        Cancel
      </button>
    </div>
  </div>
</div>



<script>
let currentCommentId = null;
let currentCommentElement = null;

document.addEventListener("DOMContentLoaded", () => {
  // Load comments for each event on page load
  document.querySelectorAll(".comment-section").forEach(section => {
    const eventId = section.dataset.eventId;
    loadEventComments(eventId);
  });

  // ====== EDIT COMMENT MODAL LOGIC ======
  const modal = document.getElementById("edit-comment-modal");
  const textarea = document.getElementById("edit-comment-text");
  const saveBtn = document.getElementById("edit-comment-save-btn");
  const cancelBtn = document.getElementById("edit-comment-cancel-btn");

  // global function used by onclick="openEditComment(...)"
  window.openEditComment = function(commentId) {
    const commentDiv = document.querySelector(`.comment[data-comment-id="${commentId}"]`);
    if (!commentDiv) return;

    const contentEl = commentDiv.querySelector(".comment-content");
    currentCommentId = commentId;
    currentCommentElement = contentEl;

    textarea.value = contentEl.textContent.trim();
    modal.style.display = "flex";
  };

  cancelBtn.addEventListener("click", () => {
    modal.style.display = "none";
    currentCommentId = null;
    currentCommentElement = null;
  });

  saveBtn.addEventListener("click", () => {
    const newContent = textarea.value.trim();
    if (!newContent) {
      alert("Comment cannot be empty.");
      return;
    }

    fetch(`/comments/${currentCommentId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ content: newContent })
    })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
        return;
      }

      if (currentCommentElement) {
        currentCommentElement.textContent = newContent;
      }

      modal.style.display = "none";
      currentCommentId = null;
      currentCommentElement = null;
    })
    .catch(err => {
      console.error(err);
      alert("Error updating comment");
    });
  });
});

// ====== COMMENTS + VOTES FUNCTIONS ======

function loadEventComments(eventId) {
  fetch(`/comments/event/${eventId}`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById(`comments-event-${eventId}`);
      container.innerHTML = data.map(c => `
  <div class="comment" data-comment-id="${c.comment_id}">
    <div class="comment-header">
      <strong>${c.author}</strong>
      ${c.owned ? `
        <span class="comment-actions">
          <button class="comment-edit" type="button" onclick="openEditComment(${c.comment_id})">Edit</button>
          <button class="comment-delete" type="button" onclick="deleteComment(${c.comment_id}, ${eventId}, null)">Delete</button>
        </span>
      ` : ""}
    </div>

    <p class="comment-content">${c.content}</p>
    <span class="time">${new Date(c.created_at).toLocaleString()}</span>
  </div>
`).join("");
    });
}

function postEventComment(eventId) {
  const input = document.getElementById(`input-event-${eventId}`);
  const content = input.value.trim();
  if (!content) return;

  fetch("/comments", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      content: content,
      event_id: Number(eventId),
      resource_id: null
    })
  }).then(() => {
    input.value = "";
    loadEventComments(eventId);
  });
}

function toggleComments(eventId) {
  const box = document.getElementById(`comments-box-${eventId}`);
  const btn = box.previousElementSibling;

  if (box.style.display === "none") {
    box.style.display = "block";
    btn.textContent = "ðŸ’¬ Hide Comments";
    loadEventComments(eventId);
  } else {
    box.style.display = "none";
    btn.textContent = "ðŸ’¬ View Comments";
  }
}

function deleteComment(commentId, eventId, resourceId) {
  if (!confirm("Delete this comment?")) return;

  fetch(`/comments/${commentId}`, { method: "DELETE" })
    .then(res => res.json())
    .then(() => {
      if (eventId) loadEventComments(eventId);
    });
}

async function vote(type, id, voteType) {
  let res = await fetch(`/votes/${type}/${id}`, {
    method: 'POST',
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ vote: voteType })
  });

  const data = await res.json();

  if (res.status === 403) {
      alert("You must be logged in to vote.");
      return;
  }

  if (data.message === "already voted") {
      alert("You already cast this vote.");
      return;
  }

  if (data.deleted) {
  location.reload(); // flash will show after reload
  return;
}

location.reload();
}
</script>


{% endblock %}
