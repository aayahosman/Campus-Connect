{% extends "base.html" %}
{% block content %}
<h2>Community Resources</h2>

<div class="resource-header">
  {% if session.get('logged_in') %}
  <a href="{{ url_for('resources.add_resource') }}" class="btn">+ Add New Resource</a>
  {% else %}
  <a href="{{ url_for('resources.add_resource') }}"
       class="btn add-btn disabled-btn"
       title="Login required">
       + Add New Resource
  </a>
  {% endif %}
</div>

<form method="get" class="search-filter">
  <label for="q" class="sr-only">Search resources</label>
<input
  id="q"
  type="text"
  name="q"
  placeholder="Search resources..."
  value="{{ q or '' }}"
>

<label for="category" class="sr-only">Filter by category</label>
<select id="category" name="category">

    <option value="">All categories</option>
    {% for c in categories %}
      <option value="{{ c }}"
        {% if selected_category == c %}selected{% endif %}>
        {{ c }}
      </option>
    {% endfor %}
  </select>

  <div class="search-filter-buttons">
    <button type="submit" class="search-btn">Search</button>

    <a href="{{ url_for('resources.list_resources') }}" class="clear-filter-btn">
      Clear Filters
    </a>
  </div>
</form>



<div class="resource-grid">
  {% for r in resources %}
  <div class="resource-card">

    {% if r.created_by == session.get('user_id') %}
      <div class="card-badge-you">Added by you</div>
    {% endif %}

    <h3>{{ r.title }}</h3>

    <!-- ALWAYS show content -->
    <p><strong>Category:</strong> {{ r.category }}</p>
    <p><strong>Description:</strong> {{ r.description }}</p>

    {% if r.contact_info %}
      <p><strong>Contact:</strong> {{ r.contact_info }}</p>
    {% endif %}

    <p><strong>Status:</strong>
      <span class="status {{ r.status }}">{{ r.status }}</span>
    </p>

    <div class="actions">
      <a href="{{ url_for('resources.edit_resource', resource_id=r.resource_id) }}" class="btn-sm edit">Edit</a>

      <form action="{{ url_for('resources.delete_resource', resource_id=r.resource_id) }}"
            method="POST" class="inline-form">
        <button type="submit" class="btn-sm delete">Delete</button>
      </form>
    </div>

    <!-- NOW put verification + votes at the BOTTOM (matches events) -->
    <div class="verification-box">

      {% if r.upvotes >= 25 %}
        <span class="verified">âœ” Verified by community</span>
      {% elif r.status == 'flagged' %}
        <span class="flagged">âš  Needs review</span>
      {% elif r.status == 'removed' %}
        <span class="removed">âœ– Removed</span>
      {% else %}
        <span class="unverified">â§— Pending verification</span>
      {% endif %}

      <div class="vote-box">
        <button class="vote-btn" onclick="vote('resource','{{ r.resource_id }}','up')">â¬†</button>
        <span>{{ r.upvotes }}</span>

        <button class="vote-btn" onclick="vote('resource','{{ r.resource_id }}','down')">â¬‡</button>
        <span>{{ r.downvotes }}</span>
      </div>

      
    </div>

    <!-- COMMENTS -->
    <div class="comment-section" data-resource-id="{{ r.resource_id }}">
      <button class="toggle-comments-btn"
        aria-expanded="false"
        aria-label="Toggle comments"
        onclick="toggleComments('{{ r.resource_id }}')">
        ðŸ’¬ View Comments
</button>


      <div class="comments-area" id="comments-box-{{ r.resource_id }}" style="display:none;">
        <div class="comments-list" id="comments-{{ r.resource_id }}"></div>

        {% if session.get('logged_in') %}
          <label for="input-{{ r.resource_id }}" class="sr-only">
            Write a comment
          </label>
          <textarea
            class="comment-input"
            id="input-{{ r.resource_id }}"
            placeholder="Write a comment...">
          </textarea>

          <button class="comment-post-btn" onclick="postResourceComment('{{ r.resource_id }}')">Post</button>
        {% else %}
          <p class="comment-login-msg">Login to leave a comment.</p>
        {% endif %}
      </div>
    </div>

</div>

  {% else %}
    {% if q or selected_category %}
      <p>No resources matched your search.</p>
    {% else %}
      <p>No resources posted yet. Add one to get started!</p>
    {% endif %}
  {% endfor %}
</div>
<!-- Edit Comment Modal -->
<div id="edit-comment-modal" class="modal-overlay" style="display: none;">
  <div class="modal">
    <h3>Edit your comment</h3>
    <label for="edit-comment-text" class="sr-only">
    Edit comment text
    </label>
    <textarea id="edit-comment-text" rows="4"></textarea>


    <div class="modal-actions">
      <button id="edit-comment-save-btn" class="modal-btn modal-btn-primary">Save</button>
      <button id="edit-comment-cancel-btn" class="modal-btn modal-btn-secondary">Cancel</button>
    </div>

  </div>
</div>
<!-- Delete Comment Modal -->
<div id="delete-comment-modal" class="modal-overlay" style="display: none;">
  <div class="modal modal-danger">
    <h3>Delete comment?</h3>
    <p style="margin: 0.25rem 0 0.75rem 0; font-size: 0.9rem;">
      This action canâ€™t be undone.
    </p>

    <div class="modal-actions">
      <button id="delete-comment-confirm-btn" class="modal-btn modal-btn-primary" style="background-color:#d32f2f;">
        Delete
      </button>
      <button id="delete-comment-cancel-btn" class="modal-btn modal-btn-secondary">
        Cancel
      </button>
    </div>
  </div>
</div>


<script>
/* Load comments on page load */
// ====== EDIT COMMENT MODAL LOGIC (shared) ======
let currentCommentId = null;
let currentCommentElement = null;

document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("edit-comment-modal");
  const textarea = document.getElementById("edit-comment-text");
  const saveBtn = document.getElementById("edit-comment-save-btn");
  const cancelBtn = document.getElementById("edit-comment-cancel-btn");

  // open modal for a given comment id
  window.openEditComment = function(commentId) {
    const commentDiv = document.querySelector(`.comment[data-comment-id="${commentId}"]`);
    if (!commentDiv) return;

    const contentEl = commentDiv.querySelector(".comment-content");
    currentCommentId = commentId;
    currentCommentElement = contentEl;

    textarea.value = contentEl.textContent.trim();
    modal.style.display = "flex";
  };

  // cancel = close modal, don't change anything
  cancelBtn.addEventListener("click", () => {
    modal.style.display = "none";
    currentCommentId = null;
    currentCommentElement = null;
  });

  // save = send PUT, update DOM (no page reload)
  saveBtn.addEventListener("click", () => {
    const newContent = textarea.value.trim();
    if (!newContent) {
      alert("Comment cannot be empty.");
      return;
    }

    fetch(`/comments/${currentCommentId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ content: newContent })
    })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
        return;
      }

      if (currentCommentElement) {
        currentCommentElement.textContent = newContent;
      }

      modal.style.display = "none";
      currentCommentId = null;
      currentCommentElement = null;
    })
    .catch(err => {
      console.error(err);
      alert("Error updating comment");
    });
  });
});

/* Fetch and show comments */
function loadComments(resourceId) {
  fetch(`/comments/resource/${resourceId}`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById(`comments-${resourceId}`);
      container.innerHTML = data.map(c => `
  <div class="comment" data-comment-id="${c.comment_id}">
    <div class="comment-header">
      <strong>${c.author}</strong>
      ${c.owned ? `
        <span class="comment-actions">
          <button class="comment-edit" onclick="openEditComment(${c.comment_id})">Edit</button>
          <button class="comment-delete" onclick="deleteComment(${c.comment_id}, null, ${resourceId})">Delete</button>
        </span>
      ` : ""}
    </div>

    <p class="comment-content">${c.content}</p>
    <span class="time">${new Date(c.created_at).toLocaleString()}</span>
  </div>
`).join("");
    });
}

/* Post a comment */
function postResourceComment(resourceId) {
  const input = document.getElementById(`input-${resourceId}`);
  const content = input.value.trim();
  if (!content) return;

  fetch("/comments", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      content: content,
      event_id: null,
      resource_id: Number(resourceId)
    })
  }).then(() => {
    input.value = "";
    loadComments(resourceId);
  });
}

/* Toggle comment box */
function toggleComments(resourceId) {
  const box = document.getElementById(`comments-box-${resourceId}`);
  const btn = box.previousElementSibling;

  if (box.style.display === "none") {
    box.style.display = "block";
    btn.textContent = "ðŸ’¬ Hide Comments";
    loadComments(resourceId);
  } else {
    box.style.display = "none";
    btn.textContent = "ðŸ’¬ View Comments";
  }
}
function deleteComment(commentId, eventId, resourceId) {
  if (!confirm("Delete this comment?")) return;

  fetch(`/comments/${commentId}`, { method: "DELETE" })
    .then(res => res.json())
    .then(() => {
      if (resourceId) loadComments(resourceId);
    });
}


// function editComment(commentId, oldContent) {
//   const newContent = prompt("Edit your comment:", oldContent);
//   if (newContent === null) return;

//   fetch(`/comments/${commentId}`, {
//     method: "PUT",
//     headers: { "Content-Type": "application/json" },
//     body: JSON.stringify({ content: newContent })
//   })
//   .then(res => res.json())
//   .then(() => {
//     // reload both pages correctly
//     const eventBox = document.querySelector(`[id^="comments-event-"]`);
//     const resourceBox = document.querySelector(`[id^="comments-resource-"]`);

//     if (eventBox) {
//       const eventId = eventBox.id.replace("comments-event-", "");
//       loadEventComments(eventId);
//     }
//     if (resourceBox) {
//       const resourceId = resourceBox.id.replace("comments-resource-", "");
//       loadResourceComments(resourceId);
//     }
//   });
// }

async function vote(type, id, voteType) {
    let res = await fetch(`/votes/${type}/${id}`, {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ vote: voteType })
    });

    const data = await res.json();

    if (res.status === 403) {
        alert("You must be logged in to vote.");
        return;
    }

    if (data.message === "already voted") {
        alert("You already cast this vote.");
        return;
    }

    location.reload();
}

</script>

{% endblock %}
